@page "/expenses/create"
@using TravelExpenseWebApp.Models
@using TravelExpenseWebApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject TravelExpenseApiService ApiService
@inject NavigationManager Navigation
@inject TravelExpenseUIUpdateService TravelExpenseUIUpdateService
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>æ—…è²»ç²¾ç®— - æ–°è¦ç™»éŒ²</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-7">
            <h1>æ—…è²»ç²¾ç®— - æ–°è¦ç™»éŒ²</h1>

            @if (errorMessage != null)
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @if (successMessage != null)
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <EditForm Model="@request" OnValidSubmit="HandleSubmit" FormName="ExpenseCreateForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

                <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">ç”³è«‹è€…å *</label>
                <InputText class="@($"form-control {GetFieldClass("ApplicantName")}")" @bind-Value="request.ApplicantName" readonly />
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">å‡ºå¼µæ—¥ *</label>
                <InputDate class="@($"form-control {GetFieldClass("TravelDate")}")" @bind-Value="request.TravelDate" />
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">å‡ºå¼µå…ˆ *</label>
                <InputText class="@($"form-control {GetFieldClass("Destination")}")" @bind-Value="request.Destination" />
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">äº¤é€šæ‰‹æ®µ *</label>
                <InputSelect class="@($"form-control {GetFieldClass("Transportation")}")" @bind-Value="request.Transportation">
                    <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                    <option value="æ–°å¹¹ç·š">æ–°å¹¹ç·š</option>
                    <option value="é£›è¡Œæ©Ÿ">é£›è¡Œæ©Ÿ</option>
                    <option value="é›»è»Š">é›»è»Š</option>
                    <option value="ãƒã‚¹">ãƒã‚¹</option>
                    <option value="ã‚¿ã‚¯ã‚·ãƒ¼">ã‚¿ã‚¯ã‚·ãƒ¼</option>
                    <option value="è‡ªå®¶ç”¨è»Š">è‡ªå®¶ç”¨è»Š</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </InputSelect>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">ç›®çš„ *</label>
        <InputTextArea class="@($"form-control {GetFieldClass("Purpose")}")" rows="3" @bind-Value="request.Purpose" />
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">äº¤é€šè²»</label>
                <InputNumber class="@($"form-control {GetFieldClass("TransportationCost")}")" @bind-Value="request.TransportationCost" />
            </div>
        </div>
        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">å®¿æ³Šè²»</label>
                <InputNumber class="@($"form-control {GetFieldClass("AccommodationCost")}")" @bind-Value="request.AccommodationCost" />
            </div>
        </div>
        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">é£Ÿäº‹ä»£</label>
                <InputNumber class="@($"form-control {GetFieldClass("MealCost")}")" @bind-Value="request.MealCost" />
            </div>
        </div>
        <div class="col-md-3">
            <div class="mb-3">
                <label class="form-label">ãã®ä»–</label>
                <InputNumber class="@($"form-control {GetFieldClass("OtherCost")}")" @bind-Value="request.OtherCost" />
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">åˆè¨ˆé‡‘é¡</label>
        <div class="form-control-plaintext fw-bold fs-4">
            @TotalAmount.ToString("N0") å††
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">å‚™è€ƒ</label>
        <InputTextArea class="@($"form-control {GetFieldClass("Remarks")}")" rows="3" @bind-Value="request.Remarks" />
    </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ç™»éŒ²
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </EditForm>
        </div>

        <div class="col-lg-5">
            <div class="chat-container-wrapper">
                <div class="chat-tabs">
                    <button class="chat-tab @(activeTab == "text" ? "active" : "")" @onclick="@(() => SetActiveTab("text"))">
                        <i class="bi bi-chat-dots"></i> ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒƒãƒˆ
                    </button>
                    <button class="chat-tab @(activeTab == "voice" ? "active" : "")" @onclick="@(() => SetActiveTab("voice"))">
                        <i class="bi bi-mic-fill"></i> éŸ³å£°ãƒãƒ£ãƒƒãƒˆ
                    </button>
                </div>
                
                @if (activeTab == "text")
                {
                    <ChatComponent />
                }
                else
                {
                    <VoiceChatComponent OnExpenseDataReceived="HandleVoiceExpenseData" />
                }
            </div>
        </div>
    </div>
</div>

@code {
[SupplyParameterFromForm]
private TravelExpenseRequest request { get; set; } = new()
{
    TravelDate = DateTime.Now,
    TransportationCost = 0,
    AccommodationCost = 0,
    MealCost = 0,
    OtherCost = 0
};

private bool isSubmitting = false;
private string? errorMessage;
private string? successMessage;
private string activeTab = "text"; // Default to text chat

// AI auto-fill highlight tracking
private HashSet<string> highlightedFields = new();
private System.Threading.Timer? highlightTimer;

private int TotalAmount =>
    request.TransportationCost +
    request.AccommodationCost +
    request.MealCost +
    request.OtherCost;

private string GetFieldClass(string fieldName)
{
    return highlightedFields.Contains(fieldName) ? "ai-updated" : "";
}

private void SetActiveTab(string tab)
{
    activeTab = tab;
}

protected override async Task OnInitializedAsync()
{
    Console.WriteLine("ğŸ”§ ExpenseCreate: Registering event handler");
    TravelExpenseUIUpdateService.TravelExpenseUIUpdateRequested += HandleTravelExpenseUIUpdate;
    Console.WriteLine("âœ… ExpenseCreate: Event handler registered");
    
    // Entra IDã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°åã‚’å–å¾—
    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
    var user = authState.User;
    
    if (user.Identity?.IsAuthenticated == true)
    {
        // æ°åã®å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆå„ªå…ˆé †ä½é †ï¼‰
        var displayName = user.FindFirst("name")?.Value 
                       ?? user.FindFirst(ClaimTypes.Name)?.Value
                       ?? user.FindFirst("preferred_username")?.Value
                       ?? user.Identity.Name
                       ?? "ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼";
        
        request.ApplicantName = displayName;
        Console.WriteLine($"âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: {displayName}");
    }
}

private void HandleTravelExpenseUIUpdate(TravelExpenseUIUpdateInstruction instruction)
{
    Console.WriteLine("ğŸ¯ ExpenseCreate: Received UI update event!");
    
    // æ›´æ–°ã•ã‚Œã‚‹é …ç›®ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    int updatedFieldsCount = 0;
    
    // Clear previous highlights
    highlightedFields.Clear();
    
    // ç”³è«‹è€…åã¯Entra IDã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®æ›´æ–°ã¯ç„¡è¦–
    // if (!string.IsNullOrEmpty(instruction.ApplicantName))
    // {
    //     request.ApplicantName = instruction.ApplicantName;
    //     highlightedFields.Add("ApplicantName");
    // }

    if (instruction.TravelDate.HasValue)
    {
        request.TravelDate = instruction.TravelDate.Value;
        highlightedFields.Add("TravelDate");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… å‡ºå¼µæ—¥: {instruction.TravelDate.Value:yyyy-MM-dd}");
    }

    if (!string.IsNullOrEmpty(instruction.Destination))
    {
        request.Destination = instruction.Destination;
        highlightedFields.Add("Destination");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… å‡ºå¼µå…ˆ: {instruction.Destination}");
    }

    if (!string.IsNullOrEmpty(instruction.Transportation))
    {
        request.Transportation = instruction.Transportation;
        highlightedFields.Add("Transportation");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… äº¤é€šæ‰‹æ®µ: {instruction.Transportation}");
    }

    if (!string.IsNullOrEmpty(instruction.Purpose))
    {
        request.Purpose = instruction.Purpose;
        highlightedFields.Add("Purpose");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… ç›®çš„: {instruction.Purpose}");
    }

    if (instruction.TransportationCost.HasValue)
    {
        request.TransportationCost = (int)instruction.TransportationCost.Value;
        highlightedFields.Add("TransportationCost");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… äº¤é€šè²»: {instruction.TransportationCost.Value:N0}å††");
    }

    if (instruction.AccommodationCost.HasValue)
    {
        request.AccommodationCost = (int)instruction.AccommodationCost.Value;
        highlightedFields.Add("AccommodationCost");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… å®¿æ³Šè²»: {instruction.AccommodationCost.Value:N0}å††");
    }

    if (instruction.MealCost.HasValue)
    {
        request.MealCost = (int)instruction.MealCost.Value;
        highlightedFields.Add("MealCost");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… é£Ÿäº‹ä»£: {instruction.MealCost.Value:N0}å††");
    }

    if (instruction.OtherCost.HasValue)
    {
        request.OtherCost = (int)instruction.OtherCost.Value;
        highlightedFields.Add("OtherCost");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… ãã®ä»–: {instruction.OtherCost.Value:N0}å††");
    }

    if (!string.IsNullOrEmpty(instruction.Notes))
    {
        request.Remarks = instruction.Notes;
        highlightedFields.Add("Remarks");
        updatedFieldsCount++;
        Console.WriteLine($"   âœ… å‚™è€ƒ: {instruction.Notes.Substring(0, Math.Min(50, instruction.Notes.Length))}...");
    }

    Console.WriteLine($"âœ… ExpenseCreate: {updatedFieldsCount}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    InvokeAsync(StateHasChanged);
    
    // Remove highlights after 10 seconds
    highlightTimer?.Dispose();
    highlightTimer = new System.Threading.Timer(_ =>
    {
        highlightedFields.Clear();
        InvokeAsync(StateHasChanged);
    }, null, TimeSpan.FromSeconds(10), Timeout.InfiniteTimeSpan);
}

/// <summary>
/// éŸ³å£°ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æ—…è²»ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸæ™‚ã®å‡¦ç†
/// </summary>
private void HandleVoiceExpenseData(TravelExpenseData data)
{
    Console.WriteLine("ğŸ™ï¸ ExpenseCreate: Received voice expense data!");
    
    // Clear previous highlights
    highlightedFields.Clear();
    
    if (!string.IsNullOrEmpty(data.Destination))
    {
        request.Destination = data.Destination;
        highlightedFields.Add("Destination");
        Console.WriteLine($"   âœ… å‡ºå¼µå…ˆ: {data.Destination}");
    }

    if (data.TravelDate.HasValue)
    {
        request.TravelDate = data.TravelDate.Value;
        highlightedFields.Add("TravelDate");
        Console.WriteLine($"   âœ… å‡ºå¼µæ—¥: {data.TravelDate.Value:yyyy-MM-dd}");
    }

    if (!string.IsNullOrEmpty(data.Purpose))
    {
        request.Purpose = data.Purpose;
        highlightedFields.Add("Purpose");
        Console.WriteLine($"   âœ… ç›®çš„: {data.Purpose}");
    }

    if (!string.IsNullOrEmpty(data.TransportationType))
    {
        request.Transportation = data.TransportationType;
        highlightedFields.Add("Transportation");
        Console.WriteLine($"   âœ… äº¤é€šæ‰‹æ®µ: {data.TransportationType}");
    }

    if (data.TransportationCost.HasValue)
    {
        request.TransportationCost = data.TransportationCost.Value;
        highlightedFields.Add("TransportationCost");
        Console.WriteLine($"   âœ… äº¤é€šè²»: {data.TransportationCost.Value:N0}å††");
    }

    if (data.AccommodationCost.HasValue)
    {
        request.AccommodationCost = data.AccommodationCost.Value;
        highlightedFields.Add("AccommodationCost");
        Console.WriteLine($"   âœ… å®¿æ³Šè²»: {data.AccommodationCost.Value:N0}å††");
    }

    if (data.DailyAllowance.HasValue)
    {
        // æ—¥å½“ã¯ã€Œãã®ä»–ã€ã«å…¥ã‚Œã‚‹ï¼ˆæ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯æ—¥å½“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ãŸã‚ï¼‰
        request.OtherCost += data.DailyAllowance.Value;
        highlightedFields.Add("OtherCost");
        Console.WriteLine($"   âœ… æ—¥å½“: {data.DailyAllowance.Value:N0}å††ï¼ˆãã®ä»–ã«åŠ ç®—ï¼‰");
    }

    if (!string.IsNullOrEmpty(data.Notes))
    {
        // æ—¢å­˜ã®å‚™è€ƒã«è¿½åŠ 
        if (!string.IsNullOrEmpty(request.Remarks))
        {
            request.Remarks += "\n\n" + data.Notes;
        }
        else
        {
            request.Remarks = data.Notes;
        }
        highlightedFields.Add("Remarks");
        Console.WriteLine($"   âœ… å‚™è€ƒã‚’è¿½åŠ ");
    }

    if (data.IsAutoFilled)
    {
        Console.WriteLine("   â„¹ï¸ éå»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸ");
    }

    InvokeAsync(StateHasChanged);
    
    // Remove highlights after 10 seconds
    highlightTimer?.Dispose();
    highlightTimer = new System.Threading.Timer(_ =>
    {
        highlightedFields.Clear();
        InvokeAsync(StateHasChanged);
    }, null, TimeSpan.FromSeconds(10), Timeout.InfiniteTimeSpan);
}

public void Dispose()
{
    TravelExpenseUIUpdateService.TravelExpenseUIUpdateRequested -= HandleTravelExpenseUIUpdate;
    highlightTimer?.Dispose();
}

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;
            successMessage = null;
            
            await ApiService.CreateExpenseAsync(request);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            successMessage = "ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼";
            
            // ç”³è«‹è€…åã‚’ä¿æŒã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            var currentApplicantName = request.ApplicantName;
            request = new TravelExpenseRequest
            {
                ApplicantName = currentApplicantName,
                TravelDate = DateTime.Now,
                TransportationCost = 0,
                AccommodationCost = 0,
                MealCost = 0,
                OtherCost = 0
            };
            
            // 1.5ç§’å¾Œã«ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            await Task.Delay(1500);
            Navigation.NavigateTo("/expenses", forceLoad: true);
        }
        catch (Microsoft.AspNetCore.Components.NavigationException)
        {
            // NavigationException ã¯æ­£å¸¸ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ãªã®ã§ç„¡è¦–
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„
        }
        catch (Exception ex)
        {
            errorMessage = $"ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/expenses");
    }
}

<style>
    .chat-container-wrapper {
        position: sticky;
        top: 20px;
        height: calc(100vh - 100px);
        max-height: 700px;
        min-height: 500px;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã‚’è¦ªã«åˆã‚ã›ã‚‹ */
    .chat-container-wrapper .chat-container {
        height: 100%;
    }
    
    .chat-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 0;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
        border: 1px solid #dee2e6;
        border-bottom: none;
        padding: 4px;
    }
    
    .chat-tab {
        flex: 1;
        padding: 10px 16px;
        border: none;
        background-color: transparent;
        color: #6c757d;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .chat-tab:hover {
        background-color: #e9ecef;
        color: #495057;
    }
    
    .chat-tab.active {
        background-color: white;
        color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chat-tab i {
        font-size: 1.1rem;
    }
    
    .chat-container-wrapper .chat-container,
    .chat-container-wrapper .voice-chat-container {
        border-radius: 0 0 8px 8px;
        border-top: none;
    }
</style>
