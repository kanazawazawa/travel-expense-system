@using TravelExpenseWebApp.Models
@using TravelExpenseWebApp.Services
@using Microsoft.Extensions.Configuration
@using System.Text.Json
@using System.Reflection
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration configuration
@inject IJSRuntime JSRuntime
@inject TravelExpenseWebApp.Services.AzureAIAgentService AzureAIAgentService
@inject TravelExpenseWebApp.Services.AgentModeService AgentModeService
@inject TravelExpenseWebApp.Services.TravelExpenseUIUpdateService TravelExpenseUIUpdateService
@implements IDisposable
@rendermode InteractiveServer

<div class="chat-container">
    <div class="chat-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">æ—…è²»ç”³è«‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h5>
                @{
                    var currentAgentName = AzureAIAgentService.GetCurrentAgentName();
                    var buildInfo = GetBuildInfo();
                    if (!string.IsNullOrEmpty(currentAgentName))
                    {
                        var shortId = currentAgentName.Length > 8 ? currentAgentName.Substring(0, 8) + "..." : currentAgentName;
                        <small class="text-muted">Agent: @shortId</small>
                    }
                    else
                    {
                        <small class="text-warning">Agent: Not configured</small>
                    }
                    <br/>
                    <small class="text-muted" style="font-size: 0.65rem;" title="@buildInfo">ğŸ”¨ @buildInfo</small>
                }
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleAgentSettings" title="Agent Settings">
                    <i class="bi bi-gear"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" @onclick="StartNewConversation">
                    <i class="bi bi-plus-circle"></i> New
                </button>
            </div>
        </div>
        
        @if (showAgentSettings)
        {
            <div class="agent-settings mt-2 p-2 border rounded bg-light">
                <div class="row align-items-center mb-2">
                    <div class="col-auto">
                        <small class="text-muted">Current Agent Name:</small>
                    </div>
                    <div class="col">
                        <code class="small bg-white px-2 py-1 rounded border @(AzureAIAgentService.IsAgentNameModified() ? "border-warning" : "")">
                            @(AzureAIAgentService.GetCurrentAgentName() ?? "Not set")
                        </code>
                        @if (AzureAIAgentService.IsAgentNameModified())
                        {
                            <small class="text-warning ms-2"><i class="bi bi-exclamation-triangle"></i> Modified</small>
                        }
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(AzureAIAgentService.GetOriginalAgentName()))
                {
                    <div class="row align-items-center mb-2">
                        <div class="col-auto">
                            <small class="text-muted">Original (env):</small>
                        </div>
                        <div class="col">
                            <code class="small bg-light px-2 py-1 rounded border text-muted">
                                @AzureAIAgentService.GetOriginalAgentName()
                            </code>
                        </div>
                    </div>
                }
                <div class="row align-items-center">
                    <div class="col-auto">
                        <small class="text-muted">New Agent Name:</small>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" @bind="tempAgentName" placeholder="Enter Agent Name" />
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-success" @onclick="UpdateAgentId" disabled="@string.IsNullOrWhiteSpace(tempAgentName)">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary ms-1" @onclick="CancelAgentSettings">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(agentSettingsMessage))
                {
                    <div class="mt-1">
                        <small class="@(agentSettingsSuccess ? "text-success" : "text-danger")">@agentSettingsMessage</small>
                    </div>
                }
            </div>
        }
    </div>
    
    <div class="chat-messages" id="chatMessages">
        @if (chatHistory.Count == 0)
        {
            <div class="chat-message agent-message">
                <div class="message-content">
                    <p>ã“ã‚“ã«ã¡ã¯ï¼æ—…è²»ç”³è«‹ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ—…è²»ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚ä¾‹ï¼šã€Œæ±äº¬ã‹ã‚‰å¤§é˜ªã¸ã®å‡ºå¼µã€äº¤é€šè²»15000å††ã€</p>
                </div>
            </div>
        }
        else
        {
            @foreach (var msg in chatHistory)
            {
                <div class="chat-message @(msg.IsUser ? "user-message" : "agent-message")">
                    <div class="message-content">
                        @if (msg.IsUser)
                        {
                            <p>@msg.Content</p>
                        }
                        else
                        {
                            @if (!string.IsNullOrEmpty(msg.FormattedContent))
                            {
                                @((MarkupString)msg.FormattedContent)
                            }
                            else
                            {
                                <p>@msg.Content</p>
                            }
                            
                            @* EXPENSE_UPDATEè¡ŒãŒã‚ã‚‹å ´åˆã¯æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ã«ã™ã‚‹ *@
                            @if (HasExpenseUpdate(msg.Content))
                            {
                                var expenseUpdates = GetExpenseUpdates(msg.Content);
                                var messageId = $"msg-{msg.Timestamp.Ticks}";
                                <div class="expense-update-section">
                                    <button class="btn-show-details" @onclick="() => ToggleExpenseUpdateVisibility(messageId)">
                                        <i class="bi @(IsExpenseUpdateVisible(messageId) ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                        @(IsExpenseUpdateVisible(messageId) ? "æŠ€è¡“æƒ…å ±ã‚’éš ã™" : "æŠ€è¡“æƒ…å ±ã‚’è¡¨ç¤º")
                                    </button>
                                    @if (IsExpenseUpdateVisible(messageId))
                                    {
                                        <div class="expense-update-details">
                                            @foreach (var update in expenseUpdates)
                                            {
                                                <code>@update</code>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        }

        @if (isLoading)
        {
            <div class="chat-message agent-message">
                <div class="message-content typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        }
    </div>

    @if (!isAgentReady)
    {
        <div class="agent-initializing">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æº–å‚™ä¸­... @(initializationCountdown)ç§’</span>
        </div>
    }
    
    <div class="chat-input-container">
        <button class="chat-attach-btn" @onclick="TriggerFileInput" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜" disabled="@(!isAgentReady || isLoading)">
            <i class="bi bi-paperclip"></i>
        </button>
        <InputFile @ref="inputFile" 
                   OnChange="HandleFileSelected" 
                   accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.webp" 
                   style="display: none;" />
        <input type="text" 
               id="chatInput"
               class="chat-input" 
               placeholder="@(isAgentReady ? "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." : "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæº–å‚™ä¸­...")" 
               @bind="chatMessage" 
               @bind:event="oninput" 
               @onkeypress="HandleKeyPress" 
               disabled="@(!isAgentReady)" />
        <button class="chat-send-btn" @onclick="SendChatMessage" disabled="@(!isAgentReady || isLoading || (string.IsNullOrWhiteSpace(chatMessage) && selectedFile == null))">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
    
    @if (selectedFile != null)
    {
        <div class="file-preview">
            <div class="file-info">
                <i class="bi @GetFileIcon(selectedFile.Name)"></i>
                <span class="file-name">@selectedFile.Name</span>
                <span class="file-size">(@FormatFileSize(selectedFile.Size))</span>
                <button class="btn-remove-file" @onclick="RemoveSelectedFile" title="å‰Šé™¤">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        </div>
    }
</div>

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background-color: white;
    }

    .chat-header {
        padding: 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .alert-sm {
        font-size: 0.8rem;
        line-height: 1.3;
    }
    
    .agent-settings {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        font-size: 0.875rem;
    }
    
    .agent-settings .form-control-sm {
        font-size: 0.8rem;
        height: calc(1.5em + 0.25rem + 2px);
    }
    
    .agent-settings .btn-sm {
        padding: 0.1rem 0.3rem;
        font-size: 0.8rem;
    }
    
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background-color: #f8f9fa;
        min-height: 0;
    }
    
    .chat-message {
        display: flex;
        margin-bottom: 10px;
    }
    
    .user-message {
        justify-content: flex-end;
    }
    
    .agent-message {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 85%;
        padding: 10px 15px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .user-message .message-content {
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .agent-message .message-content {
        background-color: #e9ecef;
        color: #212529;
        border-bottom-left-radius: 5px;
    }
    
    .message-content p {
        margin: 0;
        font-size: 0.9rem;
    }
    
    .agent-initializing {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 15px;
        background-color: #fff3cd;
        border-top: 1px solid #ffc107;
        border-bottom: 1px solid #ffc107;
        color: #856404;
        font-size: 0.875rem;
    }
    
    .chat-input-container {
        display: flex;
        padding: 15px;
        background-color: white;
        border-top: 1px solid #dee2e6;
        gap: 10px;
    }
    
    .chat-input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
    
    .chat-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        outline: none;
        font-size: 0.9rem;
    }
    
    .chat-attach-btn {
        width: 40px;
        height: 40px;
        border: none;
        background-color: transparent;
        color: #6c757d;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
    }`n    .chat-attach-btn i { font-size: 1.2rem; }`n    .chat-send-btn i { font-size: 1.2rem; }
    
    .chat-attach-btn:hover {
        background-color: #f8f9fa;
        color: #0d6efd;
    }
    
    .chat-attach-btn:disabled {
        color: #dee2e6;
        cursor: not-allowed;
    }
    
    .chat-send-btn {
        width: 40px;
        height: 40px;
        border: none;
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .chat-send-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
    
    .file-preview {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    .file-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.875rem;
    }
    
    .file-info i {
        font-size: 1.2rem;
        color: #0d6efd;
    }
    
    .file-name {
        flex-grow: 1;
        font-weight: 500;
        color: #212529;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .file-size {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    .btn-remove-file {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-remove-file:hover {
        color: #bb2d3b;
    }
    
    /* Typing indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 2px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6c757d;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    .typing-dot:nth-child(3) {
        animation-delay: 0;
    }
    
    @@keyframes typing {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }
    
    /* EXPENSE_UPDATE details section */
    .expense-update-section {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #dee2e6;
    }
    
    .btn-show-details {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
    }
    
    .btn-show-details:hover {
        background-color: #f8f9fa;
        color: #0d6efd;
    }
    
    .btn-show-details i {
        font-size: 0.9rem;
    }
    
    .expense-update-details {
        margin-top: 8px;
        padding: 8px;
        background-color: #f8f9fa;
        border-left: 3px solid #0d6efd;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
    }
    
    .expense-update-details code {
        display: block;
        padding: 4px 8px;
        margin: 2px 0;
        background-color: #e9ecef;
        border-radius: 3px;
        color: #495057;
        word-break: break-all;
    }
</style>

@code {
private List<ChatMessage> chatHistory = new List<ChatMessage>();
private string chatMessage = string.Empty;
private bool isLoading = false;
private string? currentThreadId;
    
// Agent settings variables
private bool showAgentSettings = false;
private string tempAgentName = string.Empty;
private string agentSettingsMessage = string.Empty;
private bool agentSettingsSuccess = false;
private string? lastKnownAgentName = null;
    
// EXPENSE_UPDATE visibility tracking
private HashSet<string> visibleExpenseUpdates = new();
    
    // File upload variables
    private InputFile? inputFile;
    private IBrowserFile? selectedFile;
    private const long MaxFileSize = 10 * 1024 * 1024; // 10MB
    
    // Agent readiness tracking
    private bool isAgentReady = false;
    private int initializationCountdown = 5; // seconds
    private System.Threading.Timer? countdownTimer;
    
    // Scroll control
    private bool needsScrolling = false;

    protected override async Task OnInitializedAsync()
    {
        // Initialize with the current thread ID if available
        currentThreadId = AgentModeService.CurrentThreadId;
        
        // Initialize temp Agent Name with current value
        tempAgentName = AzureAIAgentService.GetCurrentAgentName() ?? string.Empty;
        lastKnownAgentName = tempAgentName;
        
        // Subscribe to agent ready events
        AgentModeService.OnAgentReadyChanged += HandleAgentReadyChanged;
        
        // Check if already ready (thread pre-created by MainLayout)
        if (AgentModeService.IsAgentReady && !string.IsNullOrEmpty(currentThreadId))
        {
            Console.WriteLine($"âœ… [ChatComponent] Thread already pre-created by MainLayout: {currentThreadId}");
            isAgentReady = true;
            return;
        }
        
        // ğŸš€ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’äº‹å‰ä½œæˆï¼ˆåˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é«˜é€ŸåŒ–ï¼‰
        // MainLayoutã§ä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (string.IsNullOrEmpty(currentThreadId))
        {
            Console.WriteLine("âš ï¸ [ChatComponent] Thread not pre-created, starting countdown...");
            // Start countdown timer
            StartCountdownTimer();
            
            _ = Task.Run(async () =>
            {
                try
                {
                    var threadId = await AzureAIAgentService.CreateThreadAsync();
                    currentThreadId = threadId;
                    AgentModeService.CurrentThreadId = threadId;
                    AgentModeService.IsAgentReady = true;
                    isAgentReady = true;
                    countdownTimer?.Dispose();
                    Console.WriteLine($"âœ… [ChatComponent] Thread pre-created: {threadId}");
                    await InvokeAsync(StateHasChanged);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"âŒ [ChatComponent] Failed to pre-create thread: {ex.Message}");
                    isAgentReady = true; // Allow user to try anyway
                    countdownTimer?.Dispose();
                    await InvokeAsync(StateHasChanged);
                }
            });
        }
        else
        {
            isAgentReady = true;
            AgentModeService.IsAgentReady = true;
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        // Check if Agent Name has changed (e.g., after reconnection)
        var currentAgentName = AzureAIAgentService.GetCurrentAgentName();
        if (currentAgentName != lastKnownAgentName)
        {
            lastKnownAgentName = currentAgentName;
            tempAgentName = currentAgentName ?? string.Empty;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Register JS function for scrolling
            await JSRuntime.InvokeVoidAsync("eval", @"
                window.scrollToBottom = function(elementId) {
                    var element = document.getElementById(elementId);
                    if (element) {
                        element.scrollTop = element.scrollHeight;
                    }
                }
            ");
            
            // Load chat history asynchronously after the first render for better performance
            await LoadChatHistoryAsync();
        }
        
        // Simple clipboard paste handler
        await SetupSimpleClipboardPaste();
        
        // Scroll to bottom only when needed
        if (needsScrolling)
        {
            await ScrollToBottom();
            needsScrolling = false;
        }
    }
    
    private void StartCountdownTimer()
    {
        countdownTimer = new System.Threading.Timer(async _ =>
        {
            if (initializationCountdown > 0)
            {
                initializationCountdown--;
                await InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }
    
    private async Task LoadChatHistoryAsync()
    {
        if (string.IsNullOrEmpty(currentThreadId))
        {
            return;
        }

        // For now, we'll skip loading chat history from the service
        // as the method doesn't exist in the current implementation
        await Task.CompletedTask;
    }

    private void StartNewConversation()
    {
        // Clear the current thread ID
        currentThreadId = null;
        AgentModeService.CurrentThreadId = null;
        
        // Reset the chat history
        chatHistory.Clear();
        
        // Add a welcome message
        chatHistory.Add(new ChatMessage
        {
            Content = "ã“ã‚“ã«ã¡ã¯ï¼æ—…è²»ç”³è«‹ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ—…è²»ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚ä¾‹ï¼šã€Œæ±äº¬ã‹ã‚‰å¤§é˜ªã¸ã®å‡ºå¼µã€äº¤é€šè²»15000å††ã€",
            IsUser = false,
            Timestamp = DateTime.Now
        });
        
        // Update the UI
        StateHasChanged();
    }

    private async Task SendChatMessage()
    {
        if (string.IsNullOrWhiteSpace(chatMessage) && selectedFile == null)
            return;
            
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®æº–å‚™
        string displayMessage = chatMessage;
        if (selectedFile != null)
        {
            displayMessage += $"\nğŸ“ {selectedFile.Name} ({FormatFileSize(selectedFile.Size)})";
        }
            
        // Add user message to chat history
        chatHistory.Add(new ChatMessage { 
            Content = displayMessage, 
            IsUser = true,
            Timestamp = DateTime.Now 
        });
        
        string userMessage = chatMessage; // Save before clearing
        chatMessage = string.Empty; // Clear input field immediately
        needsScrolling = true; // Mark that we need to scroll
        StateHasChanged(); // Update UI immediately to show user message
        await Task.Delay(10); // Small delay to ensure render completes
        byte[]? fileBytes = null;
        string? fileName = null;
        string? contentType = null;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”»åƒãŒã‚ã‚‹å ´åˆã¯ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›
        if (selectedFile != null)
        {
            try
            {
                // Blazor Serverã§ã¯OpenReadStream()ã¯åŒæœŸèª­ã¿è¾¼ã¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãŸã‚ã€
                // éåŒæœŸã§ãƒã‚¤ãƒˆé…åˆ—ã«èª­ã¿è¾¼ã‚€
                using var stream = selectedFile.OpenReadStream(MaxFileSize);
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                fileBytes = memoryStream.ToArray();
                fileName = selectedFile.Name;
                contentType = selectedFile.ContentType;
            }
            catch (Exception ex)
            {
                chatHistory.Add(new ChatMessage
                {
                    Content = $"ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {ex.Message}",
                    IsUser = false,
                    Timestamp = DateTime.Now
                });
                StateHasChanged();
                return;
            }
        }
        
        var fileToSend = selectedFile;
        selectedFile = null; // Clear selected file
        isLoading = true;
        needsScrolling = true;
        StateHasChanged(); // Force UI update to show typing indicator
        await Task.Delay(50); // Small delay to ensure render
        
        try
        {
            // Create a thread if this is the first message (should be rare due to pre-creation)
            if (string.IsNullOrEmpty(currentThreadId))
            {
                Console.WriteLine("âš ï¸ Thread not pre-created, creating now...");
                currentThreadId = await AzureAIAgentService.CreateThreadAsync();
                AgentModeService.CurrentThreadId = currentThreadId;
            }
            else
            {
                Console.WriteLine($"âœ… Using pre-created thread: {currentThreadId}");
            }
              
            // Send message to Azure AI Agent and get response
            string aiResponse;
            
            if (fileBytes != null && fileName != null)
            {
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ã€ç”»åƒä»˜ãã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                if (IsImageFile(fileName))
                {
                    // ãƒã‚¤ãƒˆé…åˆ—ã‹ã‚‰ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆ
                    using var imageStream = new MemoryStream(fileBytes);
                    
                    // ç”»åƒåˆ†æç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                    string imagePrompt = string.IsNullOrWhiteSpace(userMessage) 
                        ? "ã“ã®ç”»åƒã‹ã‚‰æ—…è²»ç”³è«‹ã«é–¢é€£ã™ã‚‹æƒ…å ±ï¼ˆæ—¥ä»˜ã€å‡ºå¼µå…ˆã€é‡‘é¡ã€ç›®çš„ãªã©ï¼‰ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚ç”»åƒå†…ã®æ–‡å­—ã‚„è¡¨ã‚’ã™ã¹ã¦èª­ã¿å–ã‚Šã€é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚" 
                        : $"{userMessage}\n\næ·»ä»˜ã—ãŸç”»åƒã‹ã‚‰æ—…è²»ç”³è«‹ã«é–¢é€£ã™ã‚‹æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚";
                    
                    Console.WriteLine($"ğŸ–¼ï¸ Sending image message: {fileName}");
                    aiResponse = await AzureAIAgentService.SendMessageWithImageAsync(currentThreadId, imagePrompt, imageStream, fileName);
                }
                else if (fileName.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
                {
                    // PDFã¯ç¾æ™‚ç‚¹ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡
                    userMessage += $"\n\n[PDFãƒ•ã‚¡ã‚¤ãƒ«ã€Œ{fileName}ã€ã‚’æ·»ä»˜ã—ã¾ã—ãŸã€‚ã“ã®PDFã®å†…å®¹ã‚’åˆ†æã—ã¦ã€å‡ºå¼µæƒ…å ±ï¼ˆæ—¥ä»˜ã€å ´æ‰€ã€é‡‘é¡ãªã©ï¼‰ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚]";
                    aiResponse = await AzureAIAgentService.SendMessageAsync(currentThreadId, userMessage);
                }
                else
                {
                    aiResponse = await AzureAIAgentService.SendMessageAsync(currentThreadId, userMessage);
                }
            }
            else
            {
                aiResponse = await AzureAIAgentService.SendMessageAsync(currentThreadId, userMessage);
            }
            
            // Format the response for better HTML display
            string formattedResponse = FormatAgentResponse(aiResponse);
            
            // Add AI response to chat history BEFORE parsing UI instructions
            chatHistory.Add(new ChatMessage { 
                Content = aiResponse,
                FormattedContent = formattedResponse,
                IsUser = false,
                Timestamp = DateTime.Now 
            });
            
            // Parse AI response for UI update instructions
            // (chatHistoryã«è¿½åŠ ã•ã‚ŒãŸå¾Œãªã®ã§ã€GenerateChatSummary()ãŒæ­£ã—ãå‹•ä½œã™ã‚‹)
            ParseAndExecuteUIInstructions(aiResponse);
        }
        catch (Exception ex)
        {
            // Handle any errors during AI communication
            chatHistory.Add(new ChatMessage { 
                Content = $"Sorry, I encountered an error: {ex.Message}. Please try again later.", 
                IsUser = false,
                Timestamp = DateTime.Now 
            });
        }
        finally
        {
            isLoading = false;
            needsScrolling = true; // Mark that we need to scroll
            StateHasChanged(); // Update UI with AI response
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(chatMessage) && !isLoading)
        {
            await SendChatMessage();
        }
    }

    private string FormatAgentResponse(string response)
    {
        // EXPENSE_UPDATEè¡Œã‚’é™¤å¤–
        var lines = response.Split('\n');
        var filteredLines = lines
            .Where(line => !line.Trim().StartsWith("EXPENSE_UPDATE:", StringComparison.OrdinalIgnoreCase))
            .ToList();
        
        response = string.Join("\n", filteredLines);
        
        // ãƒ•ã‚£ãƒ«ã‚¿å¾Œã«ç©ºã«ãªã£ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
        if (string.IsNullOrWhiteSpace(response))
        {
            return "ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚";
        }
        
        // Handle markdown-style bold text (convert **text** to <strong>text</strong>)
        response = System.Text.RegularExpressions.Regex.Replace(
            response, 
            @"\*\*([^*]+)\*\*", 
            "<strong>$1</strong>");
            
        // Handle line breaks and bullet points
        return response
            .Replace("\n\n", "<br><br>")
            .Replace("\n", "<br>")
            .Replace("â€¢", "<br>â€¢");
    }
    
    /// <summary>
    /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«EXPENSE_UPDATEè¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    /// </summary>
    private bool HasExpenseUpdate(string content)
    {
        if (string.IsNullOrEmpty(content))
            return false;
            
        return content.Contains("EXPENSE_UPDATE:", StringComparison.OrdinalIgnoreCase);
    }
    
    /// <summary>
    /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰EXPENSE_UPDATEè¡Œã®ãƒªã‚¹ãƒˆã‚’å–å¾—
    /// </summary>
    private List<string> GetExpenseUpdates(string content)
    {
        if (string.IsNullOrEmpty(content))
            return new List<string>();
            
        return content.Split('\n')
            .Where(line => line.Trim().StartsWith("EXPENSE_UPDATE:", StringComparison.OrdinalIgnoreCase))
            .Select(line => line.Trim())
            .ToList();
    }
    
    /// <summary>
    /// EXPENSE_UPDATEã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    /// </summary>
    private void ToggleExpenseUpdateVisibility(string messageId)
    {
        if (visibleExpenseUpdates.Contains(messageId))
        {
            visibleExpenseUpdates.Remove(messageId);
        }
        else
        {
            visibleExpenseUpdates.Add(messageId);
        }
    }
    
    /// <summary>
    /// EXPENSE_UPDATEãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    /// </summary>
    private bool IsExpenseUpdateVisible(string messageId)
    {
        return visibleExpenseUpdates.Contains(messageId);
    }

    private async Task ScrollToBottom()
    {
        try
        {
            // Use JSRuntime to scroll to the bottom of the chat
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "chatMessages");
        }
        catch
        {
            // Silently fail if JS interop fails
        }
    }

    private void ToggleAgentSettings()
    {
        showAgentSettings = !showAgentSettings;
        if (showAgentSettings)
        {
            // Reset message and update temp ID with current value
            agentSettingsMessage = string.Empty;
            tempAgentName = AzureAIAgentService.GetCurrentAgentName() ?? string.Empty;
        }
    }

    private async Task UpdateAgentId()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(tempAgentName))
            {
                agentSettingsMessage = "Agent Name cannot be empty";
                agentSettingsSuccess = false;
                return;
            }

            // Update the Agent Name
            AzureAIAgentService.SetAgentName(tempAgentName.Trim());
            
            // Clear current thread to start fresh with new agent
            currentThreadId = null;
            AgentModeService.CurrentThreadId = null;
            chatHistory.Clear();
            
            agentSettingsMessage = "Agent Name updated successfully";
            agentSettingsSuccess = true;
            
            // Hide settings after successful update
            await Task.Delay(1500); // Show success message for 1.5 seconds
            showAgentSettings = false;
            agentSettingsMessage = string.Empty;
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            agentSettingsMessage = $"Error updating Agent Name: {ex.Message}";
            agentSettingsSuccess = false;
        }
    }

    private void CancelAgentSettings()
    {
        showAgentSettings = false;
        agentSettingsMessage = string.Empty;
        tempAgentName = AzureAIAgentService.GetCurrentAgentName() ?? string.Empty;
    }
    
    /// <summary>
    /// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
    /// </summary>
    private async Task TriggerFileInput()
    {
        if (inputFile?.Element != null)
        {
            await JSRuntime.InvokeVoidAsync("eval", $"document.querySelector('input[type=file]').click()");
        }
    }
    
    /// <summary>
    /// ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†
    /// </summary>
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        if (selectedFile.Size > MaxFileSize)
        {
            chatHistory.Add(new ChatMessage
            {
                Content = $"ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚10MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆé¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: {FormatFileSize(selectedFile.Size)}ï¼‰",
                IsUser = false,
                Timestamp = DateTime.Now
            });
            selectedFile = null;
            StateHasChanged();
            return;
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    /// </summary>
    private void RemoveSelectedFile()
    {
        selectedFile = null;
        StateHasChanged();
    }
    
    /// <summary>
    /// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    /// </summary>
    private string GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".pdf" => "bi-file-pdf-fill text-danger",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".webp" => "bi-file-image-fill text-primary",
            _ => "bi-file-earmark-fill text-secondary"
        };
    }
    
    /// <summary>
    /// ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    /// </summary>
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    
    /// <summary>
    /// ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    /// </summary>
    private bool IsImageFile(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension is ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".webp";
    }
    
    
    /// <summary>
    /// Parse AI response for UI update instructions
    /// Supports both product updates and travel expense form updates
    /// Example format: "EXPENSE_UPDATE: applicant=ç”°ä¸­å¤ªéƒ, destination=å¤§é˜ª, transportCost=15000"
    /// 
    /// è¤‡æ•°ã®EXPENSE_UPDATEè¡ŒãŒã‚ã£ã¦ã‚‚ã€ã™ã¹ã¦å‡¦ç†ã—ã¾ã™ï¼ˆé€æ¬¡çš„ãªæƒ…å ±åæ˜ ï¼‰
    /// </summary>
    private void ParseAndExecuteUIInstructions(string aiResponse)
    {
        try
        {
            var lines = aiResponse.Split('\n');
            int updateCount = 0;
            foreach (var line in lines)
            {
                // æ—…è²»ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã®æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
                if (line.Trim().StartsWith("EXPENSE_UPDATE:", StringComparison.OrdinalIgnoreCase))
                {
                    updateCount++;
                    Console.WriteLine($"ğŸ”„ Processing EXPENSE_UPDATE #{updateCount}");
                    ParseTravelExpenseUpdate(line);
                }
            }
            
            if (updateCount > 0)
            {
                Console.WriteLine($"âœ… Total EXPENSE_UPDATE processed: {updateCount}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Error parsing UI instructions: {ex.Message}");
        }
    }
    
    /// <summary>
    /// æ—…è²»ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã®æ›´æ–°ã‚’è§£æ
    /// éƒ¨åˆ†çš„ãªæƒ…å ±ã®ã¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚å‡¦ç†ã—ã¾ã™ï¼ˆé€æ¬¡æ›´æ–°å¯¾å¿œï¼‰
    /// </summary>
    private void ParseTravelExpenseUpdate(string line)
    {
        try
        {
            Console.WriteLine($"ğŸ“ Parsing EXPENSE_UPDATE: {line}");
            
            var instructionPart = line.Substring(line.IndexOf(':') + 1).Trim();
            var parameters = instructionPart.Split(',')
                .Select(p => p.Trim().Split('='))
                .Where(p => p.Length == 2)
                .ToDictionary(p => p[0].Trim().ToLowerInvariant(), p => p[1].Trim());
            
            Console.WriteLine($"ğŸ“Š Parsed {parameters.Count} parameters:");
            foreach (var kvp in parameters)
            {
                Console.WriteLine($"   âœ“ {kvp.Key} = {kvp.Value}");
            }
            
            // éƒ¨åˆ†æ›´æ–°ç”¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆnullableãªå€¤ã®ã¿è¨­å®šï¼‰
            var instruction = new TravelExpenseUIUpdateInstruction();
            
            // ç”³è«‹è€…åã¯æŒ‡å®šã—ãªã„ï¼ˆEntra IDã‹ã‚‰è‡ªå‹•å–å¾—ã•ã‚Œã‚‹ãŸã‚ï¼‰
            // if (parameters.TryGetValue("applicant", out var applicant))
            //     instruction.ApplicantName = applicant;
                
            if (parameters.TryGetValue("destination", out var destination))
                instruction.Destination = destination;
            
            if (parameters.TryGetValue("transportation", out var transportation))
                instruction.Transportation = transportation;
                
            if (parameters.TryGetValue("purpose", out var purpose))
                instruction.Purpose = purpose;
                
            // å‡ºå¼µæ—¥ã®è§£æï¼šå˜ä¸€ã®æ—¥ä»˜ã¾ãŸã¯ "yyyy-MM-dd to yyyy-MM-dd" å½¢å¼
            if (parameters.TryGetValue("traveldate", out var travelDateStr))
            {
                // "to" ã‚’å«ã‚€å ´åˆã¯ç¯„å›²æŒ‡å®š
                if (travelDateStr.Contains(" to ", StringComparison.OrdinalIgnoreCase))
                {
                    var dates = travelDateStr.Split(new[] { " to " }, StringSplitOptions.RemoveEmptyEntries);
                    if (dates.Length == 2)
                    {
                        var startDateStr = dates[0].Trim();
                        // å¹´ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç¾åœ¨ã®å¹´ã‚’ä½¿ç”¨
                        if (DateTime.TryParse(startDateStr, out var startDate))
                        {
                            // å¹´ãŒæ­£ã—ãè§£æã•ã‚ŒãŸã‹ç¢ºèªï¼ˆ2æ¡å¹´ã®å ´åˆã¯ç¾åœ¨ã®å¹´ã‚’ä½¿ç”¨ï¼‰
                            if (startDate.Year < 2000)
                            {
                                startDate = new DateTime(DateTime.Now.Year, startDate.Month, startDate.Day);
                            }
                            instruction.TravelDate = startDate;
                        }
                    }
                }
                else if (DateTime.TryParse(travelDateStr, out var travelDate))
                {
                    // å¹´ãŒæ­£ã—ãè§£æã•ã‚ŒãŸã‹ç¢ºèªï¼ˆ2æ¡å¹´ã®å ´åˆã¯ç¾åœ¨ã®å¹´ã‚’ä½¿ç”¨ï¼‰
                    if (travelDate.Year < 2000)
                    {
                        travelDate = new DateTime(DateTime.Now.Year, travelDate.Month, travelDate.Day);
                    }
                    instruction.TravelDate = travelDate;
                }
            }
                
            if (parameters.TryGetValue("transportcost", out var transportCostStr) && decimal.TryParse(transportCostStr, out var transportCost))
                instruction.TransportationCost = transportCost;
                
            if (parameters.TryGetValue("accommodationcost", out var accommodationCostStr) && decimal.TryParse(accommodationCostStr, out var accommodationCost))
                instruction.AccommodationCost = accommodationCost;
                
            if (parameters.TryGetValue("mealcost", out var mealCostStr) && decimal.TryParse(mealCostStr, out var mealCost))
                instruction.MealCost = mealCost;
                
            if (parameters.TryGetValue("othercost", out var otherCostStr) && decimal.TryParse(otherCostStr, out var otherCost))
                instruction.OtherCost = otherCost;
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚µãƒãƒªã‚’å‚™è€ƒã¨ã—ã¦è¿½åŠ 
            instruction.Notes = GenerateChatSummary();
            
            Console.WriteLine($"ğŸš€ Triggering UI update with: Destination={instruction.Destination}, TransportCost={instruction.TransportationCost}");
            
            // UIæ›´æ–°ã‚’ãƒˆãƒªã‚¬ãƒ¼
            TravelExpenseUIUpdateService.RequestTravelExpenseUIUpdate(instruction);
            
            Console.WriteLine("âœ… UI update request sent");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Error parsing travel expense update: {ex.Message}");
        }
    }
    
    /// <summary>
    /// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰å‚™è€ƒç”¨ã®ã‚µãƒãƒªã‚’ç”Ÿæˆ
    /// AIã®æœ€æ–°å¿œç­”ã‹ã‚‰å‡ºå¼µæ¦‚è¦ã‚’æŠ½å‡º
    /// </summary>
    private string GenerateChatSummary()
    {
        if (chatHistory.Count == 0)
            return string.Empty;
        
        var summary = new System.Text.StringBuilder();
        
        // AIã®æœ€æ–°å¿œç­”ã‚’å–å¾—ï¼ˆEXPENSE_UPDATEè¡Œã‚’é™¤å¤–ï¼‰
        var latestAiMessage = chatHistory
            .Where(msg => !msg.IsUser)
            .OrderByDescending(msg => msg.Timestamp)
            .FirstOrDefault();
        
        if (latestAiMessage != null)
        {
            // EXPENSE_UPDATEè¡Œã‚’é™¤å¤–ã—ã¦ã‚µãƒãƒªã‚’ç”Ÿæˆ
            var lines = latestAiMessage.Content.Split('\n');
            var summaryLines = lines
                .Where(line => !line.Trim().StartsWith("EXPENSE_UPDATE:", StringComparison.OrdinalIgnoreCase))
                .Where(line => !string.IsNullOrWhiteSpace(line))
                .ToList();
            
            foreach (var line in summaryLines)
            {
                summary.AppendLine(line.Trim());
            }
        }
        
        return summary.ToString();
    }
    
    /// <summary>
    /// ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    /// </summary>
    private async Task SetupSimpleClipboardPaste()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                if (!window.clipboardPasteSetup) {
                    window.clipboardPasteSetup = true;
                    
                    document.addEventListener('paste', function(e) {
                        var chatInput = document.getElementById('chatInput');
                        if (document.activeElement !== chatInput) return;
                        
                        var items = e.clipboardData?.items;
                        if (!items) return;
                        
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
                                e.preventDefault();
                                var file = items[i].getAsFile();
                                
                                // Simulate file selection by triggering InputFile component
                                var input = document.querySelector('input[type=file]');
                                if (input) {
                                    // Create a DataTransfer object to hold the file
                                    var dataTransfer = new DataTransfer();
                                    dataTransfer.items.add(file);
                                    input.files = dataTransfer.files;
                                    
                                    // Trigger change event
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('ğŸ“‹ Pasted image simulated as file selection');
                                }
                                break;
                            }
                        }
                    });
                    
                    console.log('âœ… Simple clipboard handler ready');
                }
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âš ï¸ Clipboard setup failed: {ex.Message}");
        }
    }
    
    public void Dispose()
    {
        countdownTimer?.Dispose();
        AgentModeService.OnAgentReadyChanged -= HandleAgentReadyChanged;
    }
    
    private void HandleAgentReadyChanged()
    {
        isAgentReady = AgentModeService.IsAgentReady;
        InvokeAsync(StateHasChanged);
    }
    
    /// <summary>
    /// ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—
    /// </summary>
    private string GetBuildInfo()
    {
        try
        {
            var assembly = Assembly.GetExecutingAssembly();
            var version = assembly.GetName().Version;
            var informationalVersion = assembly.GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion;
            
            if (!string.IsNullOrEmpty(informationalVersion) && informationalVersion.Contains("Build:"))
            {
                // "Build: 2025-11-26 12:34:56 UTC" å½¢å¼ã‹ã‚‰æ—¥æ™‚ã‚’æŠ½å‡º
                return informationalVersion.Replace("Build: ", "");
            }
            
            return $"v{version}";
        }
        catch
        {
            return "Unknown";
        }
    }
}


